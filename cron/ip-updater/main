#!/bin/bash
echo -e '\n>ip-updater---' `date`;
script_path=/home/zhuylanz/script/cron/ip-updater

_urlencode() {
	python -c 'import urllib, sys; print urllib.quote(sys.argv[1], sys.argv[2])' \
	"$1" "$urlencode_safe"
}

update-dnspro() {
	cookie_name1='ASP.NET_SessionId'
	cookie_value1=`curl -v --silent 'https://dnspro.vn/Login.aspx?ReturnUrl=%2f' -H 'Connection: keep-alive' -H 'Cache-Control: max-age=0' -H 'Upgrade-Insecure-Requests: 1' -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.87 Safari/537.36' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8' -H 'Accept-Encoding: gzip, deflate, br' -H 'Accept-Language: en-US,en;q=0.9' 2>&1 | grep -o -e $cookie_name'=.*;\ path' | sed s/\;\ path//g | sed 's/'$cookie_name'=//g'`
	cookie_name2='.domaincp'
	cookie_value2=`curl -v --silent 'https://dnspro.vn/Login.aspx?ReturnUrl=%2f' -H 'Connection: keep-alive' -H 'Cache-Control: max-age=0' -H 'Origin: https://dnspro.vn' -H 'Upgrade-Insecure-Requests: 1' -H 'Content-Type: application/x-www-form-urlencoded' -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.87 Safari/537.36' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8' -H 'Referer: https://dnspro.vn/Login.aspx?ReturnUrl=%2f' -H 'Accept-Encoding: gzip, deflate, br' -H 'Accept-Language: en-US,en;q=0.9' -H 'Cookie: ASP.NET_SessionId='$cookie_value1 --data '__EVENTTARGET=btnLogin&__EVENTARGUMENT=&__VIEWSTATE=%2FwEPDwUJNDE3MzU4NDM1D2QWBAIBDw8WAh4EVGV4dAUWTm8gUmVjb3JkIGJ5IGRuc3Byby52bmRkAgIPZBYOAgEPFgIfAGVkAgIPD2QWAh4Kb25LZXlQcmVzcwVBamF2YXNjcmlwdDppZiAoZXZlbnQua2V5Q29kZSA9PSAxMykgICBfX2RvUG9zdEJhY2soJ2J0bkxvZ2luJywnJylkAgQPD2QWAh8BBUFqYXZhc2NyaXB0OmlmIChldmVudC5rZXlDb2RlID09IDEzKSAgIF9fZG9Qb3N0QmFjaygnYnRuTG9naW4nLCcnKWQCBw8PFgIfAGVkZAIIDw8WAh8AZWRkAgkPDxYCHwAFCWRuc3Byby52bmRkAgoPFgIfAGVkZG%2FT9xSMPin7Rgm8HNgWMXo8panj6vYqOd2F1n3YX5ip&__VIEWSTATEGENERATOR=C2EE9ABB&txtDomain='$1'&txtPassword='$2 2>&1 | grep -o -e '\'$cookie_name2'=.*;\ path' | sed 's/\;\ path//g' | sed 's/'$cookie_name2'=//g'`

	# update new ip:
	curl 'https://dnspro.vn/ZoneEditor.aspx' -H 'Cookie: ASP.NET_SessionId='$cookie_value1'; .domaincp='$cookie_value2 -H 'Origin: https://dnspro.vn' -H 'Accept-Encoding: gzip, deflate, br' -H 'Accept-Language: en-US,en;q=0.9' -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.87 Safari/537.36' -H 'Content-Type: application/x-www-form-urlencoded; charset=UTF-8' -H 'Accept: */*' -H 'Cache-Control: no-cache' -H 'X-Requested-With: XMLHttpRequest' -H 'Connection: keep-alive' -H 'X-MicrosoftAjax: Delta=true' -H 'Referer: https://dnspro.vn/ZoneEditor.aspx' --data 'ctl00%24rscm=ctl00%24ContentPlaceHolder1%24up_A%7Cctl00%24ContentPlaceHolder1%24gv_A%24ctl02%24btnUpdate&ctl00%24ContentPlaceHolder1%24gv_A%24ctl02%24ed_rname=%40&ctl00%24ContentPlaceHolder1%24gv_A%24ctl02%24ed_rdata='$3'&ctl00%24ContentPlaceHolder1%24gv_RF%24ctl02%24ck1=on&__EVENTTARGET=ctl00%24ContentPlaceHolder1%24gv_A%24ctl02%24btnUpdate&__EVENTARGUMENT=&__VIEWSTATE=AVHLNxaw63scHpuq9Bs1wRYmrj6dR1BhZIOYmSPaT32M8rCkDHNVOm%2FYM2L%2FdF2FLTfutyzlSkQeqPUGy%2FdbYbQmVPNZg9PbL4DA6P7w8N2nqh5Rihu3j%2BxbjkrlEbHlRNM3ipd21xaDptPOR7Vb%2BQ57DWuWwODBp2PVl9kgcoNhCsVhrWJnnSlrZe%2F3IlVExlbbxfzDcnStM0J7OLIQyU3AtW65xxjOSZ%2Bm7v4O78c5siN%2FbcR0O6k7nQXg9QuuudNA0etjUb9lWjquFCsbMIphfWHlvPJI7CKRwaF1d0C9Cu0Pb%2BKK7uACrOvW9kuJ3mm1pPJwzwU4tc0GddBOxDIX5hF%2FRbTXSicd75ndLl%2BXsGzw6ZWyarbOCLf3AB8IYa9Hk6XbJO1Njg67O%2FpYtWA32z9X%2Bcl4TJoUa%2Bl2HWO5jMKB%2BMnSlGLiDmafFLDeXaqXknVHvwkPN6xZy27TcPG2AAHrZuAFsByaqyTJFHt%2BF1iigipdRJrhIOk%2BSejY5LZxKuG9o22lPnZKkp9S7aO2kb6GhKt1vhGKGYABRS0XWU5Xdvu16073Jmia8Epkm7IGh%2FlNQzaCGAV%2BxRZyN6baHGwWWaqjMiimnbGzKFNIO1%2FAhFvhXaK0FzIzDC6%2Fm7lD0asBeNffFqjmPHjV97fad8hNTb%2FTj0xitLLQmaifkBzPKczzOt%2FbwBV9PnHfI%2FPlIdf1lGMdix8L9oGGAY4MfXn2kf70F3zfGyiDNiDsKFtmM0F0j4w8eiEOXgZsBZYWLz%2FHQzxKAyjt9ujrUu2faxFiyrNr3IJTBhhz4n%2Fhpuu3WYfUtqZCfynGHJZIG%2BrVCuVA3y2Rj%2FGgFhIhZ2%2BltpESGktf69v1PdOL97MdePcbLoG%2BRdfckjkkpXOhOetsuodDKhjmzWAhokDV001Fj7o1N3hcDBi13lRReSs%2BRYrkqjUV%2FggjgtCTzl2JMT3NxspkxwZgOQFrChIP0bW2n%2FoPk%2F1Xw3ejel3Dg1D6mfTjPnOqctl3GWn6oVupKwtvbJlV5cYNtFvKPcH1Ncn63WdnpSo24D4RNftm%2F4Bj0cY%2F0C2C1jNHdLzs2%2Bjc486PtEPPYKCjIq%2FpiS87BOLmY9J1U46oM5wUP0%2FHDjufWJkMbmmADRo0nZm0he4l%2FTQ436OALIIHE9OR9vHzdmls6acpG5e%2F2gSRwHFmRhtMMr%2BwGCjMqgn4PC2OKDVroc8pn8akDFcUY6R0asGcxy3%2FtcXtkyCcbsiU237ksZILDgOxtVaMC6EbSNSijH79D2U0w0C4ur3u6J8r6cl2fugoOVL5tpWVfPfDVBulmZL7x2Xi0wleT5R%2FLDMruCsiM3KrCStTHSAU%2Fcryuwcr8eXYX915KJFnoXnvQorAoiRMJrFqhsLwMkwqsAFx5uoIGJXsdr%2BTkOToawDuUHvU6cJhKYJn4tuO6kYObTQf31BVTykahPTmkBFTCIt1Sz95%2BmVI5qXwCUk6ICqTU5%2FQdPLBOrUSEBbJ6IZDBQVXeEhxjB68z%2BR8gJfMh%2FLTSJQNUsuuPKvvuK55e%2BuA8J7uNihfU6Gl%2Fmqwje%2BaLJlh4LIv%2BJVURlmprlqvNlE%2Bn%2B57zBNCFo2cZ2bhFAjE%2B2Ut4YjoWc2YeRaOfuBl6%2FUcjVpts9pAXuTi4hIAYNyd9e%2BiZqilrztQumz%2B%2Fvb7KLQlXx2f75NrvC2lJCEAO24n7ocRLJHoLQMoNTnQduVDAuZR%2FHLJwuwNoCZ0logWsMNUWjpEPZpFapgH88qXM7s%2F8Lljac%2Fr8VNcD5vK%2B3H1aefekghnw9LhlzrLwZadUfZAJz9xKD3tJURrdIpCU%2FQ7guQ1c4Nqk4Q8eOQJZnh2LHREC1d84eVnHGTHudse9iv83%2BKxuT%2BNds8Cyv%2BDojoRHsQqUoHHF67FQtypUxV2Oz%2FdosptD48o7wFpCsodNjU%2B%2BHY5RPTiLAlyz9pCbttOYvBAJRFTfhSyTVUiIaLstQB%2Fuk4dhTClglzDkx46izhfGz9%2BTI3ui4yyj5sFAzVkCgeiQg%2BNMhn1NBWrLvW5T7nflKqKbXjSYaF7rS1m96RpWZSdhlVOJV%2BPBgyx%2B07S45mwR8zEUIfQB%2FeQw2WurEItsAkiVWiWfU5MGRIfdX2Ct%2B6KiJqqomiwh1nSKGx4UWnG9spfl7e%2B60srb0EUTIOSTtWdSehRHmE0sUvFNpC0BcWQcFHBWFgjLeh%2FIRIANa2Bmdc%2F7CsmxwEebp4K7%2Fc6Nxe2w%2F%2FDRhDHl97GtemaVVE4SHeolAipE1rz%2B0uTri7qq9%2BBr%2FuXQ7PR7Nr14ed13a296XVjxfiqdD5FT3FiDpHum2gx50d%2F0GVWqTcGSorr50yUbBm482bzB1ewUD4VMJ10m%2Fdsd8Ppq%2BS7KufPYrJ9bJU7GHrJpTTnOrEAWPn3rTZdSqoSr3y8f%2BDzXgbKymrPQfNasbvJy%2BGe7pbiHItTEz%2BerpGovJK%2BGwkyZBUPbFrEihgxpRpcZMQQsn9ieyEBe10s%2F0f4H0Q6Dc34F57Ic81%2FUC0iEN9O%2BD9RvK2m6r26GU84HApCiDAlagE5CDhsXAWEvnmXfZrrSf%2FGiG3Zr3%2Fe9RgbehJNCywu8ml3sq51HYTlGi9rVbPIoBzms2N6IgGYUhQFEKQsCulrXO1NTJ29THpjxd2ODYkC1kTF3t%2FnrKhN1EGlN6RTfSM8AprBUu7EOKE3QzQ%2Bw2P%2B6VUivE4uSvqDO16qCl7MvEDwxStFRxlQ5SEcb%2F9RCD8fvBoFStGjA3KF%2F2JaM5OjqZBTiTeLDz6GDsW6O%2B8bSiYsFnnQsd%2B0eZNwnLvQrVqlxGiWPrBPMpmvb2mH1q%2FzgmR%2BDSBAWoe8P52uqucAUt6gVChgNRbIVHVSpMbaS7wYUPWTOHLTvNfgmhRpO0u4o1AHvza7yZGTcW7yI1mAqiHk58MsiuN9bVzN3tsgROLPydNC9Ba3wyE9ZgpXndns8hE9fqfJFvXtJVM%2FzKCYQhgE%2B7NgDlbIY129u7dt%2FCagZXnSNlEQ%2FUBJjpSpbxwMBbEc1%2BSStiyred4y2cnWI65TTKo%2BHDnwfY9J6ixXFK%2FZpIh4tpIMtaKYx4mX86x9iBnekMkArTl319YH4tIUE8ruuIbCu0TKVOPQLuTzAi%2F1OvamIB28UZW4JT6dsd8CWIzXFp4TjHkfx4JiMYNovLgGdMJRYLT4VF6CPBBl7kDV%2Bgj6lQGLyjBiYZxawffLdkwxPJARlWi1VfibM0%2BWGb3DQiojGmfpXmkyzI7MtfWSTC33JNxdLE8ys1yJpHka8PB0z%2Bm3R8bqtxS0YLmdzUd47ZR%2BXXh8cbACH20B5L9LUGg41SLK0rp4BR4KL2xSY2Al5IkUwIBs1dEYj8DgVle%2B2GEfDV09o639cHqOSSRxl%2Bo1BWuOKQWsJSYj%2FhH%2FFtypqs489l6Wqlg32DVJ7kbme%2BTGmvwZY9OzjtG%2FhiEfCbpzvkv%2FrsByYB65Z9D9UD7aWxV11PUI5hjG6Jkalw2X3%2FtZoyFXT%2BwfYpwExXzxIlGleAsNAoexRXSdCqzREn3bMgko9dg%2BB0EeGYlNe3nI94BW4oAC%2FjWRU9lcmj9zpbGdIVkB96prF6e7JZsX4afkyejGU9BPbM79BBLQNbQFyYhaB102H8cfKxyEaLCnMcZ54iwUr86Xz7W1AymA%2FoFwFP3iHJpO5LrmuwOtZwtoGlIi0e5Xtrrmkfa8XfXBwzCItCe95Im8C6XA65JYQfm%2BJrZw0mvalYhB1UGIStiOxzr4EfD1Uu1tDibFUE6yixEPvtgg6IAI7IcnRlGaXR1F5HMhZmruhS5jJCjnmWCtgBYpU6V6z%2FY%2B6s%2BEh5YM%2F6fEddWL4b9AksoyZVtP91d5f5yED3nSUcyoMFAcca90lFVmOqqHYqnepXlGVGIcwQ10eG3SO6hGXuuGazpTWLClfBj1HtBQXVoQwJKUaf63iApEHQFc9w%2Frfns%2Bbs%2FrXkssU63Itfe0szD9usZjQx58pW6XJkU2nVCXuWM53SNJztvgmheo5jCeg%2FJutByzCio%2B2APw8kQy39NAbIObSmekxowYJSQVqW%2FMLk%2BolPHVaNHy0MrokCQgGsOhmH0WIVoPrNIB1xVURp4NUoGYqb2gMmXcEVQYBXccoZmXMWVeGxDXGD9000ZevZ28tnRJmAY8qUtK%2BVIpyX%2Be1osrRtBrR2ughIT1y5YWil7kNdY2Aqqc7cfs7mXMkEE4Fyxlq1UItWGY%2F09INeAQ30pY9%2F7l1MMqTRDXNVOZH47r0eudHLjaKCPx3ZAy3eUuTY8kD0k9pchrtqW%2BLXhxZkxSOF3Pp7UCFrB2%2Bv2g%2FLz2I%2F9EATd3X43uncyOqIqHPwAuNf0EkqJLetKJMgo2Y7rO3w%3D%3D&__VIEWSTATEGENERATOR=868F393C&__VIEWSTATEENCRYPTED=&__ASYNCPOST=true&' --compressed
	sleep 5
	# going back to get ViewState:
	viewstate=`_urlencode $(curl --silent 'https://dnspro.vn/ZoneEditor.aspx' -H 'Connection: keep-alive' -H 'Cache-Control: max-age=0' -H 'Upgrade-Insecure-Requests: 1' -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.87 Safari/537.36' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8' -H 'Referer: https://dnspro.vn/' -H 'Accept-Encoding: gzip, deflate, br' -H 'Accept-Language: en-US,en;q=0.9' -H 'Cookie: ASP.NET_SessionId='$cookie_value1'; .domaincp='$cookie_value2 --compressed | grep -o -e 'VIEWSTATE" value=".*"' | sed 's/VIEWSTATE" value="//g' | sed 's/"$//g')`
	# delete old ip:
	curl 'https://dnspro.vn/ZoneEditor.aspx' -H 'Cookie: ASP.NET_SessionId='$cookie_value1'; .domaincp='$cookie_value2 -H 'Origin: https://dnspro.vn' -H 'Accept-Encoding: gzip, deflate, br' -H 'Accept-Language: en-US,en;q=0.9' -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.87 Safari/537.36' -H 'Content-Type: application/x-www-form-urlencoded; charset=UTF-8' -H 'Accept: */*' -H 'Cache-Control: no-cache' -H 'X-Requested-With: XMLHttpRequest' -H 'Connection: keep-alive' -H 'X-MicrosoftAjax: Delta=true' -H 'Referer: https://dnspro.vn/ZoneEditor.aspx' --data 'ctl00%24rscm=ctl00%24ContentPlaceHolder1%24up_A%7Cctl00%24ContentPlaceHolder1%24gv_A%24ctl02%24btnDelete&__EVENTTARGET=ctl00%24ContentPlaceHolder1%24gv_A%24ctl02%24btnDelete&__EVENTARGUMENT=&__VIEWSTATE='$viewstate'&__VIEWSTATEGENERATOR=868F393C&__VIEWSTATEENCRYPTED=&__ASYNCPOST=true&' --compressed
}

old_ip=`cat $script_path/old-ip`
new_ip=`curl icanhazip.com`
echo 'old ip: ' $old_ip
echo 'new ip: ' $new_ip

if [ $old_ip != $new_ip ]; then
	update-dnspro 'tanhopthanh.vn' 'Jhsh%$3gs#' $new_ip
	echo $new_ip > $script_path/old-ip
fi
